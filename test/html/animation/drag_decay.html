<!DOCTYPE html>
<html ng-app="myApp">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title></title>

    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="../../../../dist/css/ionic.css" />
    <script src="../../../../dist/js/ionic.bundle.js"></script>
    <script src="dynamics.js"></script>
    <style>
      #box1 {
        -webkit-transform: translate3d(100px, 100px, 0);
      }
      .box {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50px;
        background-color: #4a87ee;
      }
    </style>

  </head>

  <body>

    <ion-content has-bouncing="false" ng-controller="MyCtrl">
      <div id="box1" class="box"></div>
    </ion-content>
    <script>
      angular.module('myApp', ['ionic'])
      .controller('MyCtrl', function($scope, $ionicAnimation, $ionicGesture) {
        var b = angular.element(document.getElementById('box1'));

        var obj = {};

        var offsetX, offsetY;

        var anim = $ionicAnimation({
          name: 'dragDecay',
          deceleration: 0.997,
          repeat: 0,
          propertyName: 'x',
          propertyObject: obj,
          propertyDefault: [100,100],
          dynamicsType: ionic.Animation.Dynamics.Decay,

          onComplete: function(didComplete, droppedFrames) {
            console.log('Done. Dropped ' + droppedFrames + '. Did complete? ' + didComplete);
          },
          
          step: function(v) {
            //console.log('Stepping', v);
            b[0].style[ionic.CSS.TRANSFORM] = 'translate3d(' + (v[0]) + 'px, ' + v[1] + 'px,0)';
          },
          complete: function() {
            console.log('Animation complete!');
          }
        }, $scope.anim);

        $ionicGesture.on('dragstart', function(e) {
          var x = e.gesture.touches[0].pageX;
          var y = e.gesture.touches[0].pageY;
          var pos = anim.property.getValue();
          offsetX = x - pos[0];
          offsetY = y - pos[1];
          console.log('OFFSET START', offsetX, offsetY);
        }, b);

        $ionicGesture.on('drag', function(e) {
          var x = (e.gesture.touches[0].pageX - offsetX);
          var y = (e.gesture.touches[0].pageY - offsetY);
          var pos = anim.property.getValue();
          ionic.requestAnimationFrame(function() {
            anim.property.setValue([x, y]);
            b[0].style[ionic.CSS.TRANSFORM] = 'translate3d(' + x + 'px, ' + y + 'px,0)';
          });
        }, b);

        var g = $ionicGesture.on('dragend', function(e) {
            var vx = e.gesture.velocityX * (e.gesture.deltaX >= 0 ? 1 : -1);
            var vy = e.gesture.velocityY * (e.gesture.deltaY >= 0 ? 1 : -1);

          console.log(e, vx, vy);

          var x = e.gesture.touches[0].pageX;
          var y = e.gesture.touches[0].pageY;

          anim.dynamic.velocity = [vx*1000, vy*1000];
          console.log(anim.dynamic.velocity);
          anim.property.setValue([x, y]);
          anim.start();
          console.log('Drag End!', vx, vy);
        }, b);

      });
    </script>
  </body>
</html>
